---
- name: Machine setup with bin
  hosts: localhost
  become: false  # bin doesn't need sudo
  connection: local
  gather_facts: true

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"

    # Install minimal system packages only (what bin can't handle)
    - name: Install basic system packages (Ubuntu/WSL)
      ansible.builtin.apt:
        name:
          - git
          - curl
          - python3-pip
          - build-essential
        state: present
        update_cache: true
      become: true
      when: ansible_os_family == "Debian"

    - name: Install basic system packages (macOS)
      community.general.homebrew:
        name:
          - git
          - curl
          - python3
        state: present
      when: ansible_os_family == "Darwin"

    # Install bin binary manager
    - name: Check if bin is installed
      ansible.builtin.command: command -v bin
      register: bin_check
      failed_when: false
      changed_when: false

    - name: Install bin binary manager
      ansible.builtin.shell: |
        curl -sf https://gobinaries.com/marcosnils/bin | sh
        mkdir -p ~/.local/bin
        mv bin ~/.local/bin/
      when: bin_check.rc != 0

    # Use bin to install development tools
    - name: Install development tools via bin
      ansible.builtin.command: "~/.local/bin/bin install {{ item }}"
      loop:
        - github.com/BurntSushi/ripgrep
        - github.com/sharkdp/fd
        - github.com/neovim/neovim
        - github.com/jesseduffield/lazygit
      register: bin_install_result
      failed_when: false
      changed_when: bin_install_result.rc == 0

    - name: Setup ripgrep config
      ansible.builtin.copy:
        content: |
          # ripgrep configuration
          --smart-case
          --follow
          --hidden
          --glob=!.git/*
          --glob=!node_modules/*
          --glob=!.next/*
          --glob=!dist/*
          --glob=!build/*
        dest: ~/.ripgreprc
        mode: '0644'

    - name: Setup fd ignore file
      ansible.builtin.copy:
        content: |
          .git/
          node_modules/
          .next/
          dist/
          build/
          target/
          .DS_Store
        dest: ~/.fdignore
        mode: '0644'

    - name: Install pre-commit
      ansible.builtin.pip:
        name: pre-commit
        state: present
