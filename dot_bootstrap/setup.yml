---
- name: Machine setup with bin
  hosts: localhost
  become: false  # bin doesn't need sudo
  connection: local
  gather_facts: true

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"

    # Install minimal system packages only (what bin can't handle)
    - name: Install basic system packages (Ubuntu/WSL)
      ansible.builtin.apt:
        name:
          - git
          - curl
          - python3-pip
          - build-essential
        state: present
        update_cache: true
      become: true
      when: ansible_os_family == "Debian"

    - name: Install basic system packages (macOS)
      community.general.homebrew:
        name:
          - git
          - curl
          - python3
        state: present
      when: ansible_os_family == "Darwin"

    # Install development tools via native package managers
    - name: Install development tools (macOS)
      community.general.homebrew:
        name:
          - ripgrep
          - fd
          - neovim
          - lazygit
        state: present
      when: ansible_os_family == "Darwin"

    - name: Install development tools (Ubuntu/WSL)
      ansible.builtin.apt:
        name:
          - ripgrep
          - fd-find
          - neovim
          - lazygit
        state: present
        update_cache: true
      become: true
      when: ansible_os_family == "Debian"

    - name: Setup ripgrep config
      ansible.builtin.copy:
        content: |
          # ripgrep configuration
          --smart-case
          --follow
          --hidden
          --glob=!.git/*
          --glob=!node_modules/*
          --glob=!.next/*
          --glob=!dist/*
          --glob=!build/*
        dest: ~/.ripgreprc
        mode: '0644'

    - name: Setup fd ignore file
      ansible.builtin.copy:
        content: |
          .git/
          node_modules/
          .next/
          dist/
          build/
          target/
          .DS_Store
        dest: ~/.fdignore
        mode: '0644'

    - name: Install pre-commit
      ansible.builtin.pip:
        name: pre-commit
        state: present
